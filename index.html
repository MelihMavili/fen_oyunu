<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Canlılık Basamakları Oyunu</title>
    <style>
      body {
        background: linear-gradient(#e6f7ff, #ccf2ff);
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
        font-family: Arial, sans-serif;
        overflow: hidden;
      }

      #start-screen,
      #game-container,
      #end-screen {
        display: none;
        flex-direction: column;
        align-items: center;
      }

      #start-screen.active,
      #game-container.active,
      #end-screen.active {
        display: flex;
      }

      #hint {
        margin: 10px 0;
        padding: 8px 16px;
        background-color: #ffffff;
        border: 2px solid #4caf50;
        border-radius: 8px;
        font-size: 16px;
        color: #333;
        text-align: center;
        width: 300px;
      }

      #timer {
        margin: 10px;
        font-size: 20px;
        font-weight: bold;
      }

      #game-board {
        display: grid;
        grid-template-columns: repeat(5, 60px);
        grid-template-rows: repeat(5, 60px);
        gap: 2px;
        padding: 5px;
        margin-top: 10px;
      }

      .cell {
        width: 60px;
        height: 60px;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        border-radius: 50%;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        position: relative;
      }

      .falling {
        animation: fall 0.5s ease forwards;
      }

      @keyframes fall {
        0% {
          transform: translateY(-150px);
        }
        100% {
          transform: translateY(0);
        }
      }

      .flash {
        animation: flash 0.5s;
      }

      @keyframes flash {
        0% {
          background: #ffff99;
          transform: scale(1.3);
        }
        100% {
          background: white;
          transform: scale(1);
        }
      }

      #score,
      #high-score {
        font-size: 20px;
        font-weight: bold;
        margin: 5px;
      }

      #message {
        margin-top: 10px;
        font-size: 18px;
        color: green;
        height: 24px;
      }

      button {
        padding: 10px 20px;
        font-size: 18px;
        margin-top: 20px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
      }

      button:hover {
        background-color: #45a049;
      }

      #winners {
        margin-top: 20px;
        font-size: 16px;
        color: #333;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="start-screen" class="active">
      <h1>Canlılık Basamakları Oyunu</h1>
      <p>Hücreleri birleştirerek Organizmaya ulaş!</p>
      <form
        id="player-form"
        onsubmit="event.preventDefault(); registerPlayer();"
      >
        <input
          type="text"
          id="player-name"
          placeholder="Adınızı girin"
          required
        />
        <button type="submit">Başla</button>
      </form>
      <div id="winners"></div>
    </div>

    <div id="game-container">
      <div id="high-score">Yüksek Skor: 0</div>
      <div id="score">Skor: 0</div>
      <div id="timer">Süre: 45</div>
      <div id="hint"></div>
      <div id="message"></div>
      <div id="game-board"></div>
    </div>

    <div id="end-screen">
      <h1 id="end-message"></h1>
      <button onclick="location.reload()">Yeniden Başla</button>
    </div>

    <audio
      id="merge-sound"
      src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
    ></audio>

    <script>
      const levels = ["Hücre", "Doku", "Organ", "Sistem", "Organizma"];
      const hints = {
        Hücre: [
          "Canlının en küçük yapı birimi.",
          "Yaşamın temel taşıdır.",
          "Tüm canlılar hücrelerden oluşur.",
        ],
        Doku: [
          "Benzer hücrelerin birleşimi.",
          "Vücutta belirli işlevleri yerine getirir.",
          "Hücrelerin organize yapısıdır.",
        ],
        Organ: [
          "Birden çok dokunun birleşimidir.",
          "Belli bir işlevi olan vücut parçası.",
          "Sistemlerin temel yapı taşı.",
        ],
        Sistem: [
          "Organların birlikte çalışması.",
          "Vücuttaki görev birlikteliği.",
          "Organlar arasındaki uyum.",
        ],
        Organizma: [
          "Tüm sistemlerin birleşimi.",
          "Bağımsız bir canlıdır.",
          "Yaşamı sürdürebilen tam yapıdır.",
        ],
      };

      const boardSize = 5;
      let board = [];
      let score = 0;
      let highScore = localStorage.getItem("highScore") || 0;
      let nextItem = "";
      let timer;
      let timeLeft = 45;
      let currentPlayer = "";
      let isWin = false;

      const boardElement = document.getElementById("game-board");
      const scoreElement = document.getElementById("score");
      const highScoreElement = document.getElementById("high-score");
      const messageElement = document.getElementById("message");
      const hintElement = document.getElementById("hint");
      const timerElement = document.getElementById("timer");
      const mergeSound = document.getElementById("merge-sound");
      const endMessage = document.getElementById("end-message");

      function registerPlayer() {
        const nameInput = document.getElementById("player-name");
        if (nameInput.value.trim() !== "") {
          currentPlayer = nameInput.value.trim();
          document.getElementById("start-screen").classList.remove("active");
          document.getElementById("game-container").classList.add("active");
          startGame();
        }
      }

      function startGame() {
        score = 0;
        scoreElement.textContent = "Skor: 0";
        highScoreElement.textContent = "Yüksek Skor: " + highScore;
        timeLeft = 45;
        board = Array(boardSize)
          .fill()
          .map(() => Array(boardSize).fill(""));
        drawBoard();
        generateNextItem();
        startTimer();
      }

      function startTimer() {
        timer = setInterval(() => {
          timeLeft--;
          timerElement.textContent = "Süre: " + timeLeft;
          if (timeLeft <= 0) {
            clearInterval(timer);
            showEndScreen("Süre doldu! Skorun: " + score, false);
          }
        }, 1000);
      }

      function drawBoard() {
        boardElement.innerHTML = "";
        for (let y = 0; y < boardSize; y++) {
          for (let x = 0; x < boardSize; x++) {
            const cell = document.createElement("div");
            cell.classList.add("cell");
            cell.textContent = board[y][x];
            cell.addEventListener("click", () => placeItem(x));
            boardElement.appendChild(cell);
          }
        }
      }

      function placeItem(x) {
        for (let y = boardSize - 1; y >= 0; y--) {
          if (board[y][x] === "") {
            board[y][x] = nextItem;
            drawBoard();
            animateFall(y, x);
            setTimeout(() => {
              resolveMerges();
              generateNextItem();
              if (isBoardFull()) {
                clearInterval(timer);
                showEndScreen("Alan doldu! Skorun: " + score, false);
              }
            }, 500);
            return;
          }
        }
        alert("Bu sütun dolu!");
      }

      function randomLevel() {
        const rand = Math.random();
        if (rand < 0.8) return "Hücre";
        else if (rand < 0.97) return "Doku";
        else return "Organ";
      }

      function generateNextItem() {
        nextItem = randomLevel();
        const possibleHints = hints[nextItem];
        const selectedHint =
          possibleHints[Math.floor(Math.random() * possibleHints.length)];
        hintElement.innerHTML = selectedHint;
      }

      function animateFall(y, x) {
        const index = y * boardSize + x;
        const cell = boardElement.children[index];
        cell.classList.add("falling");
        setTimeout(() => {
          cell.classList.remove("falling");
        }, 500);
      }

      function resolveMerges() {
        let merged = false;
        for (let y = boardSize - 1; y >= 0; y--) {
          for (let x = 0; x < boardSize; x++) {
            const current = board[y][x];
            if (!current) continue;
            const directions = [
              { dx: 1, dy: 0 },
              { dx: -1, dy: 0 },
              { dx: 0, dy: 1 },
              { dx: 0, dy: -1 },
            ];
            for (let dir of directions) {
              const nx = x + dir.dx;
              const ny = y + dir.dy;
              if (nx >= 0 && nx < boardSize && ny >= 0 && ny < boardSize) {
                if (board[ny][nx] === current) {
                  const nextLevelIndex = levels.indexOf(current) + 1;
                  if (nextLevelIndex < levels.length) {
                    board[y][x] = levels[nextLevelIndex];
                    board[ny][nx] = "";
                    score += 10;
                    scoreElement.textContent = "Skor: " + score;
                    if (score > highScore) {
                      highScore = score;
                      localStorage.setItem("highScore", highScore);
                      highScoreElement.textContent =
                        "Yüksek Skor: " + highScore;
                    }
                    mergeSound.play();
                    flashCell(y, x);
                    showMessage("Yeni yapı oluştu! 🎉");
                    merged = true;
                    if (levels[nextLevelIndex] === "Organizma") {
                      clearInterval(timer);
                      showEndScreen(
                        "Tebrikler! Organizmaya ulaştın! Skorun: " + score,
                        true
                      );
                    }
                  }
                }
              }
            }
          }
        }
        if (merged) {
          compactBoard();
          setTimeout(() => {
            drawBoard();
            resolveMerges();
          }, 300);
        } else {
          drawBoard();
        }
      }

      function compactBoard() {
        for (let x = 0; x < boardSize; x++) {
          for (let y = boardSize - 1; y > 0; y--) {
            if (board[y][x] === "" && board[y - 1][x] !== "") {
              board[y][x] = board[y - 1][x];
              board[y - 1][x] = "";
            }
          }
        }
      }

      function isBoardFull() {
        for (let row of board) {
          if (row.includes("")) return false;
        }
        return true;
      }

      function flashCell(y, x) {
        const index = y * boardSize + x;
        const cell = boardElement.children[index];
        cell.classList.add("flash");
        setTimeout(() => cell.classList.remove("flash"), 500);
      }

      function showMessage(text) {
        messageElement.textContent = text;
        setTimeout(() => (messageElement.textContent = ""), 1500);
      }

      function showEndScreen(message, won) {
        isWin = won;
        document.getElementById("game-container").classList.remove("active");
        document.getElementById("end-screen").classList.add("active");
        endMessage.textContent = message;
        saveResult();
      }

      function saveResult() {
        const resultMark = isWin ? "✅" : "❌";
        let players = JSON.parse(localStorage.getItem("players") || "[]");
        players.push({
          name: currentPlayer,
          score: score,
          result: resultMark,
        });
        localStorage.setItem("players", JSON.stringify(players));
      }

      function loadWinners() {
        const winners = JSON.parse(localStorage.getItem("players") || "[]");
        const sorted = winners.sort((a, b) => b.score - a.score);
        const list = sorted
          .map((p) => `🏅 ${p.name} - Skor: ${p.score} ${p.result}`)
          .join("<br>");
        document.getElementById("winners").innerHTML = sorted.length
          ? `<h3>Oyuncular</h3>${list}`
          : "";
      }

      window.onload = loadWinners;
    </script>
  </body>
</html>
